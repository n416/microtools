<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smatt</title>
    
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; background: #000; color: #fff; 
            display: flex; flex-direction: column; height: 100vh; overflow: hidden; 
        }
        
        /* --- ã‚¿ãƒ– --- */
        .tabs { 
            display: flex; background: #111; z-index: 50; flex-shrink: 0; height: 50px; border-bottom: 1px solid #333;
        }
        .tab { 
            flex: 1; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; color: #666; font-size: 15px; font-weight: bold; transition: 0.2s;
            -webkit-user-select: none; user-select: none;
        }
        .tab.active { background: #1a1a1a; color: #fff; border-bottom: 2px solid #007bff; }
        
        .content { display: none; flex: 1; position: relative; overflow: hidden; }
        .content.active { display: flex; flex-direction: column; }

        /* --- å…±é€š: ãƒ¢ãƒ¼ãƒ€ãƒ« & ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (ä¿®æ­£é©ç”¨æ¸ˆã¿) --- */
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: none;
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px; box-sizing: border-box;
        }
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¿®æ­£æ¸ˆã¿ */
        .overlay.active { display: flex; animation: fadeInOverlay 0.3s forwards; }

        .intro-box { 
            max-width: 400px; width: 100%; margin: 0 auto;
            display: flex; flex-direction: column; align-items: center;
        }
        .intro-title { font-size: 24px; font-weight: bold; margin-bottom: 30px; color: #00d4ff; }
        .intro-step { width: 100%; margin-bottom: 25px; text-align: left; background: #222; padding: 15px; border-radius: 10px; border: 1px solid #444; box-sizing: border-box; }
        .intro-step h4 { margin: 0 0 5px 0; color: #fff; font-size: 16px; }
        .intro-step p { margin: 0; color: #aaa; font-size: 13px; line-height: 1.5; }
        
        .btn-large {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none; color: white; padding: 15px 40px; border-radius: 30px;
            font-size: 18px; font-weight: bold; cursor: pointer; margin: 10px; width: 80%;
            box-shadow: 0 4px 15px rgba(0,123,255,0.4);
        }
        .btn-large:active { transform: scale(0.98); }
        .btn-secondary { background: #444; box-shadow: none; }

        /* --- å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ --- */
        #c-send { padding: 15px; background: #121212; display: none; flex-direction: column; }
        #c-send.active { display: flex; }

        .header-area { flex-shrink: 0; width: 100%; max-width: 600px; margin: 0 auto; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        .app-logo {
            font-size: 20px; font-weight: 800;
            background: linear-gradient(45deg, #007bff, #00d4ff);
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }
        .settings-btn { font-size: 20px; cursor: pointer; padding: 5px; opacity: 0.7; }

        textarea { 
            width: 100%; height: 100px; padding: 12px; font-size: 16px; 
            border-radius: 12px; border: 1px solid #333; outline: none; 
            background: #222; color: #fff; resize: none; box-sizing: border-box; line-height: 1.4;
        }
        textarea:focus { border-color: #007bff; background: #2a2a2a; }
        
        #qrcode-container { 
            flex: 1; margin-top: 15px; background: #fff; border-radius: 16px; 
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden; width: 100%; max-width: 600px; align-self: center; 
            padding: 10px; box-sizing: border-box; position: relative;
        }
        canvas#qr-output { display: block; max-width: 100%; max-height: 100%; object-fit: contain; }
        #page-indicator {
            position: absolute; bottom: 10px; right: 15px;
            background: rgba(0,0,0,0.6); color: #fff; padding: 4px 10px;
            border-radius: 12px; font-size: 12px; pointer-events: none; display: none;
        }
        .footer-text { flex-shrink: 0; font-size: 12px; color: #666; text-align: center; margin-top: 10px; height: 20px; }

        /* --- èª­è¾¼ãƒ¢ãƒ¼ãƒ‰ --- */
        #c-receive { padding: 0; background: #000; }
        #cam-wrapper { 
            position: relative; width: 100%; height: 100%; 
            display: flex; justify-content: center; align-items: center; background: #000;
        }
        #canvas-scan { width: 100%; height: 100%; object-fit: contain; display: block; }
        #video { display: none; }

        #help-link {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            color: rgba(255,255,255,0.5); font-size: 13px; text-decoration: underline;
            cursor: pointer; z-index: 10; padding: 10px;
        }

        #toast {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 10px 24px; background: rgba(0, 0, 0, 0.85); color: #fff;
            border-radius: 30px; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 50; white-space: nowrap; border: 1px solid #444;
        }
        #toast.show { opacity: 1; }

        .modal {
            display: none; position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 350px; background: rgba(30, 30, 30, 0.95); 
            border: 1px solid #444; color: white; padding: 20px;
            border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            text-align: center; z-index: 20;
            -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); 
        }
        .modal.active { display: block; animation: fadeInOverlay 0.3s forwards; }

        #settings-modal h3, #help-modal h3 { margin: 0 0 15px 0; font-size: 16px; color: #ddd; }
        .control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-adj {
            background: #444; border: none; color: #fff; padding: 8px 12px;
            border-radius: 8px; cursor: pointer; font-size: 12px; width: 45px;
        }
        .btn-adj:active { background: #666; }
        #size-display { font-size: 20px; font-weight: bold; color: #00d4ff; width: 60px; }
        
        .btn-close {
            background: #007bff; border: none; color: #fff; padding: 10px 30px;
            border-radius: 20px; font-size: 14px; cursor: pointer; width: 100%; margin-top: 10px;
        }
        .btn-reset {
            background: transparent; border: 1px solid #444; color: #888; padding: 8px;
            border-radius: 8px; font-size: 12px; cursor: pointer; width: 100%; margin-top: 15px;
        }

        #result-modal { cursor: pointer; }
        #result-modal strong { display: block; font-size: 18px; margin-bottom: 8px; color: #00d4ff; }
        #result-modal span { display: block; font-size: 13px; color: #ccc; word-break: break-all; line-height: 1.4; }
        
        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="intro-select" class="overlay">
    <div class="intro-box">
        <div class="intro-title">Smatt</div>
        <p style="color:#aaa; margin-bottom:30px;">ã©ã¡ã‚‰ã§ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ</p>
        <button class="btn-large" onclick="introNext('send')">ğŸ“± ã‚¹ãƒãƒ› (å…¥åŠ›)</button>
        <button class="btn-large btn-secondary" onclick="introNext('receive')">ğŸ’» PC (èª­è¾¼)</button>
    </div>
</div>

<div id="intro-guide-send" class="overlay">
    <div class="intro-box">
        <div class="intro-title">ä½¿ã„æ–¹ (ã‚¹ãƒãƒ›)</div>
        <div class="intro-step">
            <h4>STEP 1</h4>
            <p>å…¥åŠ›æ¬„ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’ã©ã‚“ã©ã‚“å…¥ã‚Œã¦ãã ã•ã„ã€‚è‡ªå‹•ã§QRã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚</p>
        </div>
        <div class="intro-step">
            <h4>STEP 2</h4>
            <p>æ›¸ãçµ‚ã‚ã£ãŸã‚‰ã€QRã‚³ãƒ¼ãƒ‰ã‚’PCã®ã‚«ãƒ¡ãƒ©ã«è¦‹ã›ã¤ã‘ã‚‹ã ã‘ï¼<br>é•·ã„æ–‡ç« ã¯ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦å…¨éƒ¨è¦‹ã›ã¦ã­ã€‚</p>
        </div>
        <button class="btn-large" onclick="introFinish('send')">ã¯ã˜ã‚ã‚‹</button>
    </div>
</div>

<div id="intro-guide-receive" class="overlay">
    <div class="intro-box">
        <div class="intro-title">ä½¿ã„æ–¹ (PC)</div>
        <div class="intro-step">
            <h4>STEP 1</h4>
            <p>ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ã€ã‚¹ãƒãƒ›ã®QRã‚³ãƒ¼ãƒ‰ã‚’æ˜ ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
        <div class="intro-step">
            <h4>STEP 2</h4>
            <p>QRãŒè¤‡æ•°ãƒšãƒ¼ã‚¸ã‚ã‚‹å ´åˆã¯ã€ã‚¹ãƒãƒ›å´ã‚’ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦å…¨ã¦èª­ã¿è¾¼ã¾ã›ã¦ãã ã•ã„ã€‚<br>å…¨éƒ¨æƒã£ãŸã‚‰è‡ªå‹•ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        </div>
        <button class="btn-large" onclick="introFinish('receive')">ã¯ã˜ã‚ã‚‹</button>
    </div>
</div>

<div class="tabs">
    <div id="t-send" class="tab" onclick="switchTab('send')">å…¥åŠ›</div>
    <div id="t-receive" class="tab" onclick="switchTab('receive')">èª­è¾¼</div>
</div>

<div id="toast"></div>

<div id="c-send" class="content">
    <div class="header-area">
        <div class="header-top">
            <div class="app-logo">Smatt</div>
            <div class="settings-btn" onclick="openSettings()">âš™ï¸</div>
        </div>
        <textarea id="inp" placeholder="æ–‡å­—ã‚’å…¥åŠ›..." autofocus></textarea>
    </div>
    
    <div id="qrcode-container">
        <canvas id="qr-output"></canvas>
        <div id="page-indicator">1 / 1</div>
    </div>
    
    <div class="footer-text" id="send-status">å…¥åŠ›ã§ç”Ÿæˆ</div>
    
    <div id="settings-modal" class="modal">
        <h3>åˆ†å‰²ã‚µã‚¤ã‚ºè¨­å®š (æ–‡å­—æ•°)</h3>
        <div class="control-row">
            <button class="btn-adj" onclick="adjSize(-100)">-100</button>
            <button class="btn-adj" onclick="adjSize(-10)">-10</button>
            <span id="size-display">800</span>
            <button class="btn-adj" onclick="adjSize(10)">+10</button>
            <button class="btn-adj" onclick="adjSize(100)">+100</button>
        </div>
        <button class="btn-close" onclick="closeSettings()">å®Œäº†</button>
        <button class="btn-reset" onclick="resetIntro()">èª¬æ˜ã‚’ã‚‚ã†ä¸€åº¦è¦‹ã‚‹</button>
    </div>
</div>

<div id="c-receive" class="content">
    <div id="cam-wrapper">
        <canvas id="canvas-scan"></canvas>
        <div id="help-link" onclick="openHelp()">èª­ã¿å–ã‚Šã¥ã‚‰ã„ã¨ãã¯ï¼Ÿ</div>
        <div id="result-modal" class="modal" onclick="copyResult()">
            <strong>ã‚¿ãƒƒãƒ—ã—ã¦ã‚³ãƒ”ãƒ¼</strong>
            <span id="detected-text">...</span>
        </div>
        
        <div id="help-modal" class="modal">
            <h3 style="color:#ff4444;">âš ï¸ PCå´ã®è¨­å®šã¯ã‚ã‚Šã¾ã›ã‚“</h3>
            <p style="font-size:14px; color:#ccc; text-align:left; margin-bottom:20px;">
                QRã‚³ãƒ¼ãƒ‰ãŒèª­ã¿å–ã‚Œãªã„å ´åˆã¯ã€<strong style="color:#fff;">ã‚¹ãƒãƒ›å´ã®è¨­å®š (âš™ï¸)</strong> ã‹ã‚‰ã€Œåˆ†å‰²ã‚µã‚¤ã‚ºã€ã‚’å°ã•ãã—ã¦ãã ã•ã„ã€‚<br><br>
                PCå´ã‚’ã„ãã‚‰ã„ã˜ã£ã¦ã‚‚æ”¹å–„ã—ã¾ã›ã‚“ã€‚
            </p>
            <button class="btn-close" onclick="closeHelp()">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    <video id="video" playsinline></video>
</div>

<script>
    // --- ã‚¤ãƒ³ãƒˆãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³åˆ¶å¾¡ (æ”¹è‰¯ç‰ˆ) ---
    const introSelect = document.getElementById('intro-select');
    const introGuideSend = document.getElementById('intro-guide-send');
    const introGuideRecv = document.getElementById('intro-guide-receive');
    
    function checkIntro() {
        // ã©ã¡ã‚‰ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚‚æœªå®Œäº†ã®å ´åˆã®ã¿é¸æŠç”»é¢ã‚’å‡ºã™
        const doneSend = localStorage.getItem('smatt_intro_send_done');
        const doneRecv = localStorage.getItem('smatt_intro_receive_done');

        if (!doneSend && !doneRecv) {
            introSelect.classList.add('active');
        } else {
            // ã©ã¡ã‚‰ã‹ç‰‡æ–¹ã§ã‚‚å®Œäº†ã—ã¦ã„ã‚Œã°ã€å‰å›é–‹ã„ã¦ã„ãŸã‚¿ãƒ–ã¸
            // (æœªå®Œäº†ã®ã‚¿ãƒ–ã‚’é–‹ã„ãŸæ™‚ã«ã‚¬ã‚¤ãƒ‰ãŒå‡ºã‚‹)
            const savedMode = localStorage.getItem('smatt_mode') || 'send';
            switchTab(savedMode);
        }
    }

    function introNext(mode) {
        introSelect.classList.remove('active');
        // ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º
        document.getElementById('intro-guide-' + mode).classList.add('active');
    }

    function introFinish(mode) {
        document.getElementById('intro-guide-' + mode).classList.remove('active');
        localStorage.setItem('smatt_intro_' + mode + '_done', 'true');
        // æ”¹ã‚ã¦ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†ã‚’å®Ÿè¡Œ
        switchTab(mode);
    }

    function resetIntro() {
        if(confirm("ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’å†åº¦è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ\n(ã‚¢ãƒ—ãƒªãŒãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™)")) {
            localStorage.removeItem('smatt_intro_send_done');
            localStorage.removeItem('smatt_intro_receive_done');
            location.reload();
        }
    }

    // --- ã‚¿ãƒ–åˆ¶å¾¡ & å‰²ã‚Šè¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯ ---
    function switchTab(mode) {
        // ãã®ãƒ¢ãƒ¼ãƒ‰ã®ã‚¬ã‚¤ãƒ‰ãŒæœªå®Œäº†ãªã‚‰ã€ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã®å‰ã«ã‚¬ã‚¤ãƒ‰ã‚’å‰²ã‚Šè¾¼ã¾ã›ã‚‹
        if (!localStorage.getItem('smatt_intro_' + mode + '_done')) {
            // ã™ã§ã«ã‚¬ã‚¤ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã‘ã‚Œã°è¡¨ç¤º
            const guideEl = document.getElementById('intro-guide-' + mode);
            if (!guideEl.classList.contains('active')) {
                guideEl.classList.add('active');
            }
            return; // ã“ã“ã§å‡¦ç†ä¸­æ–­
        }

        // --- é€šå¸¸ã®åˆ‡ã‚Šæ›¿ãˆå‡¦ç† ---
        document.querySelectorAll('.tab, .content').forEach(e => e.classList.remove('active'));
        document.getElementById('t-' + mode).classList.add('active');
        document.getElementById('c-' + mode).classList.add('active');
        localStorage.setItem('smatt_mode', mode);

        if (mode === 'receive') {
            startCamera();
        } else {
            stopCamera();
            setTimeout(() => { inp.focus(); }, 100);
        }
    }

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    const toastEl = document.getElementById('toast');
    let toastTimer = null;
    function showToast(msg, duration = 1500) {
        toastEl.innerText = msg;
        toastEl.classList.add('show');
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => toastEl.classList.remove('show'), duration);
    }

    // --- å…¥åŠ› & è¨­å®šãƒ­ã‚¸ãƒƒã‚¯ ---
    const qrCanvas = document.getElementById('qr-output');
    const inp = document.getElementById('inp');
    const pageInd = document.getElementById('page-indicator');
    const qrContainer = document.getElementById('qrcode-container');
    const sendStatus = document.getElementById('send-status');
    const settingsModal = document.getElementById('settings-modal');
    const sizeDisplay = document.getElementById('size-display');

    let CHUNK_SIZE = parseInt(localStorage.getItem('smatt_chunk_size')) || 800;
    
    function openSettings() {
        sizeDisplay.innerText = CHUNK_SIZE;
        settingsModal.classList.add('active');
    }
    function closeSettings() {
        settingsModal.classList.remove('active');
        inp.focus(); 
    }
    function adjSize(delta) {
        let newVal = CHUNK_SIZE + delta;
        if (newVal > 800) newVal = 800;
        if (newVal < 30) newVal = 30;
        CHUNK_SIZE = newVal;
        sizeDisplay.innerText = CHUNK_SIZE;
        localStorage.setItem('smatt_chunk_size', CHUNK_SIZE);
        updateQR();
    }

    let chunks = [];
    let currentPage = 0; 
    let currentId = ""; 

    function updateQR() {
        const text = inp.value;
        if (!text) {
            chunks = [];
            generateQR("");
            pageInd.style.display = 'none';
            sendStatus.innerText = `åˆ†å‰²ã‚µã‚¤ã‚º: ${CHUNK_SIZE}æ–‡å­—`;
            return;
        }

        if (text.length <= CHUNK_SIZE) {
            chunks = [text];
            currentId = ""; 
        } else {
            chunks = [];
            currentId = Date.now().toString(36); 
            const total = Math.ceil(text.length / CHUNK_SIZE);
            for (let i = 0; i < total; i++) {
                const chunkData = text.substr(i * CHUNK_SIZE, CHUNK_SIZE);
                chunks.push(`SMT:${i + 1}:${total}:${currentId}:${chunkData}`);
            }
        }

        if (currentPage >= chunks.length) currentPage = chunks.length - 1;
        if (currentPage < 0) currentPage = 0;

        generateQR(chunks[currentPage]);
        updateUI();
    }

    function generateQR(data) {
        const ctx = qrCanvas.getContext('2d');
        if (!data) {
            ctx.clearRect(0, 0, qrCanvas.width, qrCanvas.height);
            return;
        }
        QRCode.toCanvas(qrCanvas, data, {
            width: 1024, margin: 1, color: { dark: "#000000", light: "#ffffff" }
        }, err => { if(err) console.error(err); });
    }

    function updateUI() {
        if (chunks.length > 1) {
            pageInd.innerText = `${currentPage + 1} / ${chunks.length}`;
            pageInd.style.display = 'block';
            sendStatus.innerText = `ã‚¹ãƒ¯ã‚¤ãƒ—ã§åˆ‡æ›¿ (${chunks.length}æš) / ã‚µã‚¤ã‚º: ${CHUNK_SIZE}`;
        } else {
            pageInd.style.display = 'none';
            sendStatus.innerText = `å®Œäº† (ã‚µã‚¤ã‚º: ${CHUNK_SIZE})`;
        }
    }

    inp.addEventListener('input', () => {
        currentPage = 0; 
        updateQR();
    });

    let startX = 0;
    qrContainer.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, {passive: true});
    qrContainer.addEventListener('touchend', e => {
        const endX = e.changedTouches[0].clientX;
        const diff = startX - endX;
        if (Math.abs(diff) > 50) { 
            if (diff > 0) nextPage(); 
            else prevPage();          
        }
    }, {passive: true});

    function nextPage() {
        if (currentPage < chunks.length - 1) {
            currentPage++;
            generateQR(chunks[currentPage]);
            updateUI();
            showToast(`ãƒšãƒ¼ã‚¸ ${currentPage + 1} / ${chunks.length}`);
        }
    }
    function prevPage() {
        if (currentPage > 0) {
            currentPage--;
            generateQR(chunks[currentPage]);
            updateUI();
            showToast(`ãƒšãƒ¼ã‚¸ ${currentPage + 1} / ${chunks.length}`);
        }
    }

    updateQR(); 

    // --- èª­è¾¼ & ãƒ˜ãƒ«ãƒ—ãƒ­ã‚¸ãƒƒã‚¯ ---
    const video = document.getElementById('video');
    const canvasScan = document.getElementById('canvas-scan');
    const ctxScan = canvasScan.getContext('2d', { willReadFrequently: true });
    const resultModal = document.getElementById('result-modal');
    const detectedTextSpan = document.getElementById('detected-text');
    const helpModal = document.getElementById('help-modal');
    
    let stream = null;
    let animeId = null;
    let isScanning = true;
    let lastRawData = "";
    let buffer = {}; 

    function openHelp() { helpModal.classList.add('active'); }
    function closeHelp() { helpModal.classList.remove('active'); }

    async function startCamera() {
        if(stream) return;
        showToast("ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...");
        resultModal.classList.remove('active');
        isScanning = true;
        buffer = {}; 

        try {
            const constraints = { video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } };
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            video.setAttribute("playsinline", true); 
            await video.play();
            showToast("QRã‚³ãƒ¼ãƒ‰ã‚’æ˜ ã—ã¦ãã ã•ã„");
            requestAnimationFrame(tick);
        } catch (e) {
            console.error(e);
            showToast("âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼");
        }
    }

    function stopCamera() {
        if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
        if (animeId) cancelAnimationFrame(animeId);
    }

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvasScan.width = video.videoWidth;
            canvasScan.height = video.videoHeight;
            ctxScan.drawImage(video, 0, 0, canvasScan.width, canvasScan.height);
            
            if(isScanning) {
                const imageData = ctxScan.getImageData(0, 0, canvasScan.width, canvasScan.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

                if (code && code.data) {
                    drawRect(code.location);
                    handleScanData(code.data);
                }
            }
        }
        animeId = requestAnimationFrame(tick);
    }

    function drawRect(loc) {
        ctxScan.beginPath();
        ctxScan.lineWidth = 5;
        ctxScan.strokeStyle = "#00d4ff"; 
        ctxScan.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
        ctxScan.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
        ctxScan.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
        ctxScan.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
        ctxScan.closePath();
        ctxScan.stroke();
    }

    function handleScanData(data) {
        if (data === lastRawData) return; 
        lastRawData = data;

        const match = data.match(/^SMT:(\d+):(\d+):([^:]+):(.*)/s);

        if (!match) {
            completeScan(data);
            return;
        }

        const index = parseInt(match[1]); 
        const total = parseInt(match[2]);
        const id = match[3];
        const content = match[4];

        if (!buffer[id]) {
            buffer[id] = { total: total, parts: {} };
        }

        if (!buffer[id].parts[index]) {
            buffer[id].parts[index] = content;
            if (navigator.vibrate) navigator.vibrate(30);
            
            const count = Object.keys(buffer[id].parts).length;
            
            if (count === total) {
                let fullText = "";
                for (let i = 1; i <= total; i++) {
                    fullText += buffer[id].parts[i];
                }
                completeScan(fullText);
            } else {
                showToast(`å—ä¿¡ä¸­... (${count} / ${total})`);
            }
        }
    }

    function completeScan(finalText) {
        isScanning = false;
        if (navigator.vibrate) navigator.vibrate([50, 50, 50]);

        showToast("âœ¨ å—ä¿¡å®Œäº†");
        
        detectedTextSpan.innerText = finalText.substring(0, 60) + (finalText.length>60?"...":"");
        resultModal.classList.add('active');

        window.currentResult = finalText;

        navigator.clipboard.writeText(finalText).then(() => {
            resultModal.querySelector('strong').innerText = "âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
        }).catch(() => {
            resultModal.querySelector('strong').innerText = "ã‚¿ãƒƒãƒ—ã—ã¦ã‚³ãƒ”ãƒ¼";
        });
    }

    window.copyResult = function() {
        const text = window.currentResult || "";
        navigator.clipboard.writeText(text).then(() => {
            alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
            resetScan();
        }).catch(err => {
            prompt("æ‰‹å‹•ã‚³ãƒ”ãƒ¼:", text);
            resetScan();
        });
    };

    function resetScan() {
        resultModal.classList.remove('active');
        buffer = {}; 
        lastRawData = "";
        showToast("å¾…æ©Ÿä¸­...");
        setTimeout(() => { isScanning = true; }, 500);
    }

    // åˆæœŸèµ·å‹•ãƒã‚§ãƒƒã‚¯
    checkIntro();
</script>
</body>
</html>