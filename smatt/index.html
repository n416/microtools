<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smatt</title>
    
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; background: #000; color: #fff; 
            display: flex; flex-direction: column; height: 100vh; overflow: hidden; 
        }
        
        /* タブ */
        .tabs { 
            display: flex; background: #111; z-index: 100; flex-shrink: 0; height: 50px; border-bottom: 1px solid #333;
        }
        .tab { 
            flex: 1; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; color: #666; font-size: 15px; font-weight: bold; transition: 0.2s;
            /* 修正2: Safari対応 */
            -webkit-user-select: none;
            user-select: none;
        }
        .tab.active { background: #1a1a1a; color: #fff; border-bottom: 2px solid #007bff; }
        
        .content { display: none; flex: 1; position: relative; overflow: hidden; }
        .content.active { display: flex; flex-direction: column; }

        /* --- 入力モード --- */
        #c-send { padding: 15px; background: #121212; display: none; flex-direction: column; }
        #c-send.active { display: flex; }

        .header-area {
            flex-shrink: 0; width: 100%; max-width: 600px; margin: 0 auto;
        }

        .header-top {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .app-logo {
            font-size: 20px; font-weight: 800;
            background: linear-gradient(45deg, #007bff, #00d4ff);
            /* 修正2: 標準プロパティの追加 */
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .settings-btn {
            font-size: 20px; cursor: pointer; padding: 5px; opacity: 0.7;
        }

        textarea { 
            width: 100%; height: 100px; padding: 12px; font-size: 16px; 
            border-radius: 12px; border: 1px solid #333; outline: none; 
            background: #222; color: #fff; resize: none; box-sizing: border-box; line-height: 1.4;
        }
        textarea:focus { border-color: #007bff; background: #2a2a2a; }
        
        #qrcode-container { 
            flex: 1; margin-top: 15px; background: #fff; border-radius: 16px; 
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden; width: 100%; max-width: 600px; align-self: center; 
            padding: 10px; box-sizing: border-box; position: relative;
        }

        canvas#qr-output { display: block; max-width: 100%; max-height: 100%; object-fit: contain; }

        #page-indicator {
            position: absolute; bottom: 10px; right: 15px;
            background: rgba(0,0,0,0.6); color: #fff; padding: 4px 10px;
            border-radius: 12px; font-size: 12px; pointer-events: none; display: none;
        }

        .footer-text {
            flex-shrink: 0; font-size: 12px; color: #666; text-align: center; margin-top: 10px; height: 20px;
        }

        /* --- 読込モード --- */
        #c-receive { padding: 0; background: #000; }
        #cam-wrapper { 
            position: relative; width: 100%; height: 100%; 
            display: flex; justify-content: center; align-items: center; background: #000;
        }
        #canvas-scan { width: 100%; height: 100%; object-fit: contain; display: block; }
        
        /* 修正3: インラインスタイル排除のためここに定義 */
        #video {
            display: none;
        }

        /* トースト */
        #toast {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 10px 24px; background: rgba(0, 0, 0, 0.85); color: #fff;
            border-radius: 30px; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 50; white-space: nowrap; border: 1px solid #444;
        }
        #toast.show { opacity: 1; }

        /* モーダル共通スタイル */
        .modal {
            display: none; position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 350px; background: rgba(30, 30, 30, 0.95); 
            border: 1px solid #444; color: white; padding: 20px;
            border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            text-align: center; z-index: 20;
            /* 修正2: Safari対応 */
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px); 
        }
        .modal.active { display: block; animation: fadeIn 0.3s forwards; }

        #settings-modal h3 { margin: 0 0 15px 0; font-size: 16px; color: #ddd; }
        .control-row {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .btn-adj {
            background: #444; border: none; color: #fff; padding: 8px 12px;
            border-radius: 8px; cursor: pointer; font-size: 12px; width: 45px;
        }
        .btn-adj:active { background: #666; }
        #size-display { font-size: 20px; font-weight: bold; color: #00d4ff; width: 60px; }
        .btn-close {
            background: #007bff; border: none; color: #fff; padding: 10px 30px;
            border-radius: 20px; font-size: 14px; cursor: pointer; width: 100%;
        }

        #result-modal { cursor: pointer; }
        #result-modal strong { display: block; font-size: 18px; margin-bottom: 8px; color: #00d4ff; }
        #result-modal span { display: block; font-size: 13px; color: #ccc; word-break: break-all; line-height: 1.4; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    </style>
</head>
<body>

<div class="tabs">
    <div id="t-send" class="tab" onclick="switchTab('send')">入力</div>
    <div id="t-receive" class="tab" onclick="switchTab('receive')">読込</div>
</div>

<div id="toast"></div>

<div id="c-send" class="content">
    <div class="header-area">
        <div class="header-top">
            <div class="app-logo">Smatt</div>
            <div class="settings-btn" onclick="openSettings()">⚙️</div>
        </div>
        <textarea id="inp" placeholder="文字を入力..." autofocus></textarea>
    </div>
    
    <div id="qrcode-container">
        <canvas id="qr-output"></canvas>
        <div id="page-indicator">1 / 1</div>
    </div>
    
    <div class="footer-text" id="send-status">入力で生成</div>
    
    <div id="settings-modal" class="modal">
        <h3>分割サイズ設定 (文字数)</h3>
        <div class="control-row">
            <button class="btn-adj" onclick="adjSize(-100)">-100</button>
            <button class="btn-adj" onclick="adjSize(-10)">-10</button>
            <span id="size-display">800</span>
            <button class="btn-adj" onclick="adjSize(10)">+10</button>
            <button class="btn-adj" onclick="adjSize(100)">+100</button>
        </div>
        <button class="btn-close" onclick="closeSettings()">完了</button>
    </div>
</div>

<div id="c-receive" class="content">
    <div id="cam-wrapper">
        <canvas id="canvas-scan"></canvas>
        <div id="result-modal" class="modal" onclick="copyResult()">
            <strong>タップしてコピー</strong>
            <span id="detected-text">...</span>
        </div>
    </div>
    <video id="video" playsinline></video>
</div>

<script>
    // --- ユーティリティ ---
    const toastEl = document.getElementById('toast');
    let toastTimer = null;
    function showToast(msg, duration = 1500) {
        toastEl.innerText = msg;
        toastEl.classList.add('show');
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => toastEl.classList.remove('show'), duration);
    }

    // --- 入力 & 設定ロジック ---
    const qrCanvas = document.getElementById('qr-output');
    const inp = document.getElementById('inp');
    const pageInd = document.getElementById('page-indicator');
    const qrContainer = document.getElementById('qrcode-container');
    const sendStatus = document.getElementById('send-status');
    const settingsModal = document.getElementById('settings-modal');
    const sizeDisplay = document.getElementById('size-display');

    // 設定値のロード (デフォルト800)
    let CHUNK_SIZE = parseInt(localStorage.getItem('smatt_chunk_size')) || 800;
    
    // 設定UI制御
    function openSettings() {
        sizeDisplay.innerText = CHUNK_SIZE;
        settingsModal.classList.add('active');
    }
    function closeSettings() {
        settingsModal.classList.remove('active');
        inp.focus(); 
    }
    function adjSize(delta) {
        let newVal = CHUNK_SIZE + delta;
        if (newVal > 800) newVal = 800;
        if (newVal < 30) newVal = 30;
        
        CHUNK_SIZE = newVal;
        sizeDisplay.innerText = CHUNK_SIZE;
        localStorage.setItem('smatt_chunk_size', CHUNK_SIZE);
        updateQR();
    }

    // QR分割生成
    let chunks = [];
    let currentPage = 0; 
    let currentId = ""; 

    function updateQR() {
        const text = inp.value;
        if (!text) {
            chunks = [];
            generateQR("");
            pageInd.style.display = 'none';
            sendStatus.innerText = `分割サイズ: ${CHUNK_SIZE}文字`;
            return;
        }

        if (text.length <= CHUNK_SIZE) {
            chunks = [text];
            currentId = ""; 
        } else {
            chunks = [];
            currentId = Date.now().toString(36); 
            const total = Math.ceil(text.length / CHUNK_SIZE);
            for (let i = 0; i < total; i++) {
                const chunkData = text.substr(i * CHUNK_SIZE, CHUNK_SIZE);
                chunks.push(`SMT:${i + 1}:${total}:${currentId}:${chunkData}`);
            }
        }

        if (currentPage >= chunks.length) currentPage = chunks.length - 1;
        if (currentPage < 0) currentPage = 0;

        generateQR(chunks[currentPage]);
        updateUI();
    }

    function generateQR(data) {
        const ctx = qrCanvas.getContext('2d');
        if (!data) {
            ctx.clearRect(0, 0, qrCanvas.width, qrCanvas.height);
            return;
        }
        QRCode.toCanvas(qrCanvas, data, {
            width: 1024, margin: 1, color: { dark: "#000000", light: "#ffffff" }
        }, err => { if(err) console.error(err); });
    }

    function updateUI() {
        if (chunks.length > 1) {
            pageInd.innerText = `${currentPage + 1} / ${chunks.length}`;
            pageInd.style.display = 'block';
            sendStatus.innerText = `スワイプで切替 (${chunks.length}枚) / サイズ: ${CHUNK_SIZE}`;
        } else {
            pageInd.style.display = 'none';
            sendStatus.innerText = `完了 (サイズ: ${CHUNK_SIZE})`;
        }
    }

    inp.addEventListener('input', () => {
        currentPage = 0; 
        updateQR();
    });

    // スワイプ操作
    let startX = 0;
    qrContainer.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, {passive: true});
    qrContainer.addEventListener('touchend', e => {
        const endX = e.changedTouches[0].clientX;
        const diff = startX - endX;
        if (Math.abs(diff) > 50) { 
            if (diff > 0) nextPage(); 
            else prevPage();          
        }
    }, {passive: true});

    function nextPage() {
        if (currentPage < chunks.length - 1) {
            currentPage++;
            generateQR(chunks[currentPage]);
            updateUI();
            showToast(`ページ ${currentPage + 1} / ${chunks.length}`);
        }
    }
    function prevPage() {
        if (currentPage > 0) {
            currentPage--;
            generateQR(chunks[currentPage]);
            updateUI();
            showToast(`ページ ${currentPage + 1} / ${chunks.length}`);
        }
    }

    updateQR(); 

    // --- タブ制御 ---
    function switchTab(mode) {
        document.querySelectorAll('.tab, .content').forEach(e => e.classList.remove('active'));
        document.getElementById('t-' + mode).classList.add('active');
        document.getElementById('c-' + mode).classList.add('active');
        localStorage.setItem('smatt_mode', mode);

        if (mode === 'receive') {
            startCamera();
        } else {
            stopCamera();
            setTimeout(() => { inp.focus(); }, 100);
        }
    }

    // --- 読込ロジック ---
    const video = document.getElementById('video');
    const canvasScan = document.getElementById('canvas-scan');
    const ctxScan = canvasScan.getContext('2d', { willReadFrequently: true });
    const resultModal = document.getElementById('result-modal');
    const detectedTextSpan = document.getElementById('detected-text');
    
    let stream = null;
    let animeId = null;
    let isScanning = true;
    let lastRawData = "";
    let buffer = {}; 

    async function startCamera() {
        if(stream) return;
        showToast("カメラ起動中...");
        resultModal.classList.remove('active');
        isScanning = true;
        buffer = {}; 

        try {
            const constraints = { video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } };
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            video.setAttribute("playsinline", true); 
            await video.play();
            showToast("QRコードを映してください");
            requestAnimationFrame(tick);
        } catch (e) {
            console.error(e);
            showToast("❌ カメラエラー");
        }
    }

    function stopCamera() {
        if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
        if (animeId) cancelAnimationFrame(animeId);
    }

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvasScan.width = video.videoWidth;
            canvasScan.height = video.videoHeight;
            ctxScan.drawImage(video, 0, 0, canvasScan.width, canvasScan.height);
            
            if(isScanning) {
                const imageData = ctxScan.getImageData(0, 0, canvasScan.width, canvasScan.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

                if (code && code.data) {
                    drawRect(code.location);
                    handleScanData(code.data);
                }
            }
        }
        animeId = requestAnimationFrame(tick);
    }

    function drawRect(loc) {
        ctxScan.beginPath();
        ctxScan.lineWidth = 5;
        ctxScan.strokeStyle = "#00d4ff"; 
        ctxScan.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
        ctxScan.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
        ctxScan.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
        ctxScan.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
        ctxScan.closePath();
        ctxScan.stroke();
    }

    function handleScanData(data) {
        if (data === lastRawData) return; 
        lastRawData = data;

        const match = data.match(/^SMT:(\d+):(\d+):([^:]+):(.*)/s);

        if (!match) {
            completeScan(data);
            return;
        }

        const index = parseInt(match[1]); 
        const total = parseInt(match[2]);
        const id = match[3];
        const content = match[4];

        if (!buffer[id]) {
            buffer[id] = { total: total, parts: {} };
        }

        if (!buffer[id].parts[index]) {
            buffer[id].parts[index] = content;
            if (navigator.vibrate) navigator.vibrate(30);
            
            const count = Object.keys(buffer[id].parts).length;
            
            if (count === total) {
                let fullText = "";
                for (let i = 1; i <= total; i++) {
                    fullText += buffer[id].parts[i];
                }
                completeScan(fullText);
            } else {
                showToast(`受信中... (${count} / ${total})`);
            }
        }
    }

    function completeScan(finalText) {
        isScanning = false;
        if (navigator.vibrate) navigator.vibrate([50, 50, 50]);

        showToast("✨ 受信完了");
        
        detectedTextSpan.innerText = finalText.substring(0, 60) + (finalText.length>60?"...":"");
        resultModal.classList.add('active');

        window.currentResult = finalText;

        navigator.clipboard.writeText(finalText).then(() => {
            resultModal.querySelector('strong').innerText = "✅ コピーしました";
        }).catch(() => {
            resultModal.querySelector('strong').innerText = "タップしてコピー";
        });
    }

    window.copyResult = function() {
        const text = window.currentResult || "";
        navigator.clipboard.writeText(text).then(() => {
            alert("コピーしました");
            resetScan();
        }).catch(err => {
            prompt("手動コピー:", text);
            resetScan();
        });
    };

    function resetScan() {
        resultModal.classList.remove('active');
        buffer = {}; 
        lastRawData = "";
        showToast("待機中...");
        setTimeout(() => { isScanning = true; }, 500);
    }

    const savedMode = localStorage.getItem('smatt_mode') || 'send';
    switchTab(savedMode);
</script>
</body>
</html>