<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:title" content="<%= (typeof ogpData !== 'undefined' && ogpData.title) ? ogpData.title : 'ダイナミックあみだくじ' %>" />
  <meta property="og:description" content="<%= (typeof ogpData !== 'undefined' && ogpData.description) ? ogpData.description : 'インタラクティブなあみだくじアプリ' %>" />
  <meta property="og:image" content="<%= (typeof ogpData !== 'undefined' && ogpData.imageUrl) ? ogpData.imageUrl : '/default-image.png' %>" />
  <meta property="og:type" content="website" />

  <% if (typeof noIndex !== 'undefined' && noIndex) { %>
  <meta name="robots" content="noindex" />
  <% } %>

  <title>ダイナミックあみだくじ</title>
  <link rel="stylesheet" href="/style.css" />
</head>

<body>
  <div id="canvas-container">
    <canvas id="grid-canvas"></canvas>
    <canvas id="animation-canvas"></canvas>
  </div>

  <% if (typeof user !== 'undefined' && user && user.isImpersonating) { %>
  <div class="impersonation-banner">
    現在、<strong><%= user.name %> (<%= user.email %>)</strong> として操作中です。
    <button id="stopImpersonatingButton">元の管理者に戻る</button>
  </div>
  <% } %>

  <header class="main-header">
    <h1>ダイナミックあみだくじ</h1>
    <div id="groupSwitcher" style="display: none">
      <button id="currentGroupName"></button>
      <div id="groupDropdown" class="dropdown-content">
        <ul id="switcherGroupList"></ul>
        <button id="switcherCreateGroup">＋ 新規グループを作成</button>
      </div>
    </div>
    <div class="auth-controls">
      <div id="authStatus"></div>
      <button id="loginButton">Googleでログイン</button>
      <button id="logoutButton" style="display: none">ログアウト</button>
      <button id="deleteAccountButton" style="display: none" class="delete-btn">アカウント削除</button>
      <% if (typeof user !== 'undefined' && user && user.role === 'system_admin' && !user.isImpersonating) { %>
      <a id="adminDashboardButton" style="cursor: pointer;">システム管理</a>
      <% } %>
    </div>
  </header>

  <div id="groupDashboard" class="view-container" style="display: none">
    <h2>マイグループ一覧</h2>
    <div class="controls">
      <div class="input-group">
        <input type="text" id="groupNameInput" placeholder="新しいグループ名" />
        <button id="createGroupButton">グループ作成</button>
      </div>
    </div>
    <ul id="groupList" class="item-list"></ul>
    <div class="controls" style="margin-top: 20px">
      <button id="requestAdminButton" style="display: none">管理者権限を申請する</button>
    </div>
  </div>

  <div id="adminDashboard" class="view-container" style="display: none">
    <h2>システム管理ダッシュボード</h2>
    <div class="controls">
      <h3>管理者申請一覧</h3>
      <ul id="pendingRequestsList" class="item-list"></ul>
    </div>
    <div class="controls">
      <h3>グループ管理者一覧</h3>
      <ul id="adminUserList" class="item-list"></ul>
    </div>
    <div class="controls">
      <h3>システム管理者一覧</h3>
      <ul id="systemAdminList" class="item-list"></ul>
    </div>
  </div>

  <div id="groupEventListView" class="view-container" style="display: none">
    <div class="event-header">
      <button id="backToDashboardFromEventListButton" style="display: none;"></button>
    </div>
    <h2 id="groupEventListName">イベント一覧を読み込んでいます...</h2>
    <ul id="groupEventList" class="item-list"></ul>
  </div>

  <div id="dashboardView" class="view-container" style="display: none">
    <h2 id="eventGroupName"></h2>

    <div id="passwordResetNotification" class="notification-banner" style="display: none;">
      <p><span id="passwordResetCount"></span>件の合言葉リセット依頼が承認を待っています。</p>
      <button id="showPasswordResetRequestsButton">詳細を表示</button>
    </div>

    <div class="controls">
      <button id="goToGroupSettingsButton">⚙️ グループ設定</button>
      <button id="goToPrizeMasterButton">🏆 賞品マスター管理</button>
      <button id="goToMemberManagementButton">👥 メンバー管理</button>
      <button id="goToCreateEventViewButton" class="primary-action">イベント新規作成</button>
    </div>
    <h3>このグループのイベント一覧</h3>
    <ul id="eventList" class="item-list"></ul>
  </div>

  <div id="memberManagementView" class="view-container" style="display: none">
    <div class="event-header">
      <button id="backToDashboardFromMembersButton">← ダッシュボードに戻る</button>
    </div>
    <h2><span id="memberManagementGroupName"></span> のメンバー管理</h2>
    <div class="controls">
      <div class="input-group">
        <input type="text" id="memberSearchInput" placeholder="メンバー名で検索..." />
        <button id="addNewMemberButton" class="primary-action">＋ メンバー追加</button>
        <button id="bulkRegisterButton">一括登録</button>
      </div>
    </div>
    <ul id="memberList" class="item-list"></ul>
  </div>

  <div id="eventEditView" class="view-container" style="display: none">
    <div class="event-header">
      <button id="backToGroupsButton">← グループ一覧に戻る</button>
    </div>
    <h3>イベント新規作成・編集</h3>
    <div class="controls">
      <div class="settings-section">
        <h4>1. イベント情報</h4>
        <div class="input-group">
          <label for="eventNameInput">イベント名:</label>
          <input type="text" id="eventNameInput" placeholder="（例: 忘年会2025）" />
        </div>
        <p>現在のイベントURL: <a id="currentEventUrl" href="#" target="_blank">（未作成または未読み込み）</a></p>
      </div>

      <div class="settings-section">
        <h4>2. 景品</h4>
        <div class="input-group prize-main-controls">
          <button id="openAddPrizeModalButton" class="primary-action">＋ 追加</button>
          <button id="bulkAddPrizesButton">テキスト流し込み</button>
          <button id="showSummaryButton">集計</button>
        </div>
        <ul id="prizeList" class="prize-card-list"></ul>
      </div>

      <div class="settings-section">
        <h4>3. 公開設定</h4>
        <div class="input-group">
          <label for="displayModeSelect">景品表示:</label>
          <select id="displayModeSelect">
            <option value="public">全員に公開</option>
            <option value="private">非公開 (???)</option>
          </select>
        </div>
      </div>

      <div class="settings-section">
        <h4>4. 作成</h4>
        <button id="createEventButton" class="primary-action">この内容でイベントを作成</button>
      </div>
    </div>
  </div>

  <div id="broadcastView" class="view-container" style="display: none">
    <div class="event-header">
      <button id="backToDashboardButton">← ダッシュボードに戻る</button>
    </div>
    <div id="adminControls">
      <button id="startEventButton" class="primary-action">🎉 イベントを開始する</button>
      <button id="startBroadcastButton">🎥 配信モードを開始</button>
    </div>
    <canvas id="adminCanvas" width="800" height="400"></canvas>
    <div class="broadcast-controls">
      <button id="animateAllButton">全結果をアニメーション再生</button>
      <button id="nextStepButton">ステップ実行</button>
      <select id="highlightUserSelect"></select>
      <button id="highlightUserButton">この参加者をハイライト</button>
    </div>
  </div>

  <div id="participantView" class="view-container" style="display: none">
    <h2 id="participantEventName">イベント読み込み中...</h2>
    <div class="event-header">
      <a href="#" id="backToGroupEventListLink" style="display: none;">← イベント一覧に戻る</a>
    </div>
    <div id="participantFlow">
      <div id="nameEntrySection" class="controls" style="display: none">
        <h3>イベントに参加</h3>
        <div class="input-group">
          <input type="text" id="nameInput" placeholder="あなたの名前を入力してください" />
          <button id="confirmNameButton">OK</button>
        </div>
        <div id="suggestionList" class="suggestion-list"></div>
      </div>
      <div id="participantControlPanel" class="controls participant-dashboard" style="display: none">
        <h3>ようこそ、<span id="welcomeName"></span> さん</h3>
        <div class="setting-group">
          <h4 class="setting-group-title">アカウント設定</h4>
          <div class="setting-group-buttons">
            <button id="editProfileButton" class="secondary-btn">プロフィール編集</button>
            <button id="setPasswordButton" class="secondary-btn">合言葉を設定</button>
          </div>
        </div>
        <div class="danger-zone">
          <button id="participantLogoutButton" class="secondary-btn">ログアウト</button>
          <button id="deleteMyAccountButton" class="secondary-btn danger">アカウントを削除</button>
        </div>
      </div>

      <div id="otherEventsSection" class="controls" style="display: none;">
        <h4>参加可能なイベント一覧</h4>
        <ul id="otherEventsList" class="item-list"></ul>
      </div>
      <div id="joinSection" style="display: none">
        <button id="backToControlPanelButton">← メニューに戻る</button>
        <div id="prizeDisplay"></div>
        <div class="slot-selection-container">
          <h3>参加枠を選んでください</h3>
          <div id="slotList"></div>
        </div>
        <div class="join-form">
          <button id="joinButton" disabled>この枠で参加する</button>
        </div>
      </div>
      <div id="waitingMessage" style="display: none">
        <p>参加登録しました！結果発表をお待ちください...</p>
        <button id="deleteParticipantWaitingButton" class="delete-btn">参加を取り消す</button>
        <button id="backToDashboardFromWaitingButton">ダッシュボードに戻る</button>
      </div>
    </div>
    <div id="resultSection" style="display: none">
      <h3>🎉 結果発表 🎉</h3>
      <canvas id="participantCanvas" height="400"></canvas>
      <p id="myResult"></p>
      <div id="allResultsContainer"></div>
      <button id="shareButton" style="display: none">結果をシェアする</button>
      <button id="backToControlPanelFromResultButton" style="display: none">戻る</button>
    </div>
  </div>

  <div id="groupSettingsModal" class="modal" style="display: none">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>グループ設定</h3>
      <input type="hidden" id="settingsGroupId" />
      <div class="input-group">
        <label for="groupNameEditInput">グループ名:</label>
        <input type="text" id="groupNameEditInput" placeholder="グループ名" />
      </div>
      <div class="input-group">
        <label for="customUrlInput">カスタムURL:</label>
        <input type="text" id="customUrlInput" placeholder="例: my-event-2025" />
      </div>
      <p class="url-preview">
        <code>/g/<span id="customUrlPreview"></span></code>
      </p>
      <div class="input-group">
        <label for="groupPasswordInput">合言葉:</label>
        <input type="password" id="groupPasswordInput" placeholder="新規設定・変更時のみ入力" />
        <button id="deletePasswordButton" class="delete-btn" style="display: none;">合言葉を削除</button>
      </div>
      <div class="input-group checkbox-group">
        <input type="checkbox" id="noIndexCheckbox" />
        <label for="noIndexCheckbox">検索エンジンに表示しない</label>
      </div>
      <hr />
      <h4>参加者リスト</h4>
      <div class="input-group">
        <input type="text" id="addParticipantNameInput" placeholder="参加者名を追加" />
        <button id="addParticipantButton">追加</button>
      </div>
      <ul id="participantManagementList"></ul>

      <button id="saveGroupSettingsButton" class="primary-action">設定を保存</button>
    </div>
  </div>

  <div id="prizeMasterModal" class="modal" style="display: none">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>賞品マスター管理</h3>
      <div class="input-group">
        <input type="text" id="addMasterPrizeNameInput" placeholder="新しい賞品名" />
        <input type="file" id="addMasterPrizeImageInput" accept="image/*" />
        <button id="addMasterPrizeButton">マスターに追加</button>
      </div>
      <ul id="prizeMasterList" class="item-list prize-master-list"></ul>
    </div>
  </div>

  <div id="passwordResetRequestModal" class="modal" style="display: none">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>合言葉リセット依頼</h3>
      <ul id="passwordResetRequestList" class="item-list"></ul>
    </div>
  </div>

  <div id="memberEditModal" class="modal" style="display: none">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>メンバー編集</h3>
      <input type="hidden" id="memberIdInput">
      <div class="input-group">
        <label for="memberNameEditInput">名前:</label>
        <input type="text" id="memberNameEditInput">
      </div>
      <div class="input-group">
        <label for="memberColorInput">カラー:</label>
        <input type="color" id="memberColorInput">
      </div>
      <button id="saveMemberButton" class="primary-action">保存</button>
    </div>
  </div>

  <div id="passwordSetModal" class="modal" style="display: none">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>合言葉の設定</h3>
      <p>合言葉を設定すると、他の人があなたのアカウントを使うのを防げます。</p>
      <div class="input-group">
        <label for="newPasswordInput">新しい合言葉:</label>
        <input type="password" id="newPasswordInput" placeholder="4文字以上" />
      </div>
      <button id="savePasswordButton" class="primary-action">設定する</button>
      <button id="deleteUserPasswordButton" class="delete-btn" style="display: none;">合言葉を削除する</button>
    </div>
  </div>

  <div id="profileEditModal" class="modal" style="display: none">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>プロフィール編集</h3>
      <div class="profile-icon-container">
        <img id="profileIconPreview" src="" alt="Profile Icon" width="100" height="100" />
        <input type="file" id="profileIconInput" accept="image/*" />
      </div>
      <div class="input-group">
        <label for="profileColorInput">テーマカラー:</label>
        <input type="color" id="profileColorInput" />
      </div>
      <button id="saveProfileButton" class="primary-action">保存する</button>
    </div>
  </div>

  <div id="prizeMasterSelectModal" class="modal" style="display: none">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>賞品をマスターから選択</h3>
      <ul id="prizeMasterSelectList" class="item-list prize-master-list"></ul>
      <button id="addSelectedPrizesButton" class="primary-action">選択した賞品を追加</button>
    </div>
  </div>

  <div id="groupPasswordModal" class="modal" style="display: none">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>合言葉の入力</h3>
      <p>グループ「<strong id="verificationTargetGroupName"></strong>」へのアクセスには合言葉が必要です。</p>
      <input type="hidden" id="verificationTargetGroupId" />
      <div class="input-group">
        <label for="groupPasswordVerifyInput">合言葉:</label>
        <input type="password" id="groupPasswordVerifyInput" />
      </div>
      <button id="verifyPasswordButton" class="primary-action">認証</button>
    </div>
  </div>

  <div id="bulkRegisterModal" class="modal" style="display: none">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>メンバーの一括登録</h3>
      <div id="bulk-step1-input">
        <p>登録したいメンバーの名前を、改行・スペース・カンマ区切りでテキストエリアに貼り付けてください。</p>
        <textarea id="bulkNamesTextarea" rows="10" placeholder="佐藤 太郎, 鈴木 一郎, ..."></textarea>
        <button id="analyzeBulkButton" class="primary-action">確認する</button>
      </div>
      <div id="bulk-step2-preview" style="display: none;">
        <p>入力された名前を分析しました。内容を確認し、登録を実行してください。</p>
        <div class="tabs">
          <button class="tab-link active" data-tab="newRegistrationTab">新規登録</button>
          <button class="tab-link" data-tab="potentialMatchTab">類似候補</button>
          <button class="tab-link" data-tab="exactMatchTab">完全一致</button>
        </div>
        <div id="newRegistrationTab" class="tab-content active"></div>
        <div id="potentialMatchTab" class="tab-content"></div>
        <div id="exactMatchTab" class="tab-content"></div>
        <button id="finalizeBulkButton" class="primary-action" disabled>この内容で登録を実行する</button>
      </div>
    </div>
  </div>

  <div id="prizeBulkAddModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>景品の一括登録・編集</h3>
      <p>景品リストを編集し、「リストを更新」ボタンを押してください。</p>
      <textarea id="prizeBulkTextarea" rows="10"></textarea>
      <div class="modal-actions">
        <button id="clearBulkPrizesButton" class="secondary-btn">クリア</button>
        <button id="updatePrizesFromTextButton" class="primary-action">リストを更新</button>
        <button id="cancelBulkAddButton" class="secondary-btn">キャンセル</button>
      </div>
    </div>
  </div>

  <div id="addPrizeModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>景品の追加</h3>
      <div class="input-group">
        <label>景品名:</label>
        <input type="text" id="newPrizeNameInput" placeholder="景品名を入力">
      </div>
      <div class="input-group">
        <label>画像:</label>
        <input type="file" id="newPrizeImageInput" accept="image/*">
      </div>
      <img id="newPrizeImagePreview" src="" alt="Image Preview" style="max-width: 100px; max-height: 100px; display: none;">
      <hr>
      <button id="callMasterButton">マスターから呼び出し</button>
      <div class="modal-actions">
        <button id="addPrizeOkButton" class="primary-action">OK</button>
      </div>
    </div>
  </div>

  <div id="summaryModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>景品集計</h3>
      <p>合計: <span id="totalPrizes"></span>個</p>
      <ul id="prizeSummaryList"></ul>
    </div>
  </div>

  <script type="module" src="/js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <script>
    <% if (typeof groupData !== 'undefined' && groupData) { %>
    const initialGroupData = <%- groupData %>;
    <% } else { %>
    const initialGroupData = null;
    <% } %>

    <% if (typeof eventData !== 'undefined' && eventData) { %>
    const initialEventData = <%- eventData %>;
    <% } else { %>
    const initialEventData = null;
    <% } %>
  </script>
</body>

</html>