<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:title" content="<%= (typeof ogpData !== 'undefined' && ogpData.title) ? ogpData.title : 'ダイナミックあみだくじ' %>" />
  <meta property="og:description" content="<%= (typeof ogpData !== 'undefined' && ogpData.description) ? ogpData.description : 'インタラクティブなあみだくじアプリ' %>" />
  <meta property="og:image" content="<%= (typeof ogpData !== 'undefined' && ogpData.imageUrl) ? ogpData.imageUrl : '/default-image.png' %>" />
  <meta property="og:type" content="website" />
  <% if (typeof noIndex !== 'undefined' && noIndex) { %>
  <meta name="robots" content="noindex" />
  <% } %>
  <title>ダイナミックあみだくじ</title>
  <link rel="stylesheet" href="/style.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
</head>

<body>
  <div id="globalLoadingMask" class="loading-mask" style="position: fixed; display: none; z-index: 9999;">
    <p>読み込み中...</p>
  </div>
  <% if (typeof error !== 'undefined' && error) { %>
  <div class="error-overlay">
    <div class="error-content">
      <h2>認証エラー</h2>
      <p><%= error.message %></p>
      <div class="error-actions">
        <a href="/auth/google" class="button primary-action">Googleでログイン</a>
        <a href="/" class="button">トップページへ戻る</a>
      </div>
    </div>
  </div>
  <% } %>
  <div id="canvas-container">
    <canvas id="grid-canvas"></canvas>
    <canvas id="animation-canvas"></canvas>
  </div>
  <% if (typeof user !== 'undefined' && user && user.isImpersonating) { %>
  <div class="impersonation-banner">
    現在、<strong><%= user.name %> (<%= user.email %>)</strong> として操作中です。
    <button id="stopImpersonatingButton">元の管理者に戻る</button>
  </div>
  <% } %>
  <header class="main-header">
    <h1>ダイナミックあみだくじ</h1>
    <button id="hamburger-button" aria-label="メニューを開く" aria-controls="nav-menu" aria-expanded="false">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <div id="nav-menu">
      <%
        let homeUrl = "/";
        if (typeof user !== 'undefined' && user && user.id) {
          if (user.lastUsedGroupId) {
            homeUrl = `/admin/groups/${user.lastUsedGroupId}`;
          } else {
            homeUrl = "/admin/groups";
          }
        }
      %>
      <a href="<%= homeUrl %>" class="button header-icon-button" id="homeButton" title="ホーム"><i data-lucide="<%= emojiToLucide('🏠') %>"></i><span>ホーム</span></a>

      <div class="group-switcher-container" style="display: none;">
        <label class="group-switcher-label">グループ選択</label>
        <div id="groupSwitcher">
          <button id="currentGroupName"></button>
          <div id="groupDropdown" class="dropdown-content">
            <ul id="switcherGroupList"></ul>
            <button id="switcherCreateGroup"><i data-lucide="+"></i> 新規グループを作成</button>
          </div>
        </div>
      </div>

      <div class="header-dropdown" id="tutorialMenuContainer" style="display: none;">
        <button class="button header-icon-button" id="tutorialMenuButton">
          <i data-lucide="<%= emojiToLucide('❔') %>"></i>
          <span>チュートリアル</span>
          <i data-lucide="<%= emojiToLucide('▼') %>" class="dropdown-arrow"></i>
          <span class="notification-dot" style="display: none;"></span>
        </button>
        <div class="dropdown-content">
          <ul id="tutorialDropdownList" class="item-list"></ul>
          <a href="/tutorials" class="dropdown-item-link" id="viewAllTutorialsLink">すべて表示</a>
        </div>
      </div>

      <div class="header-dropdown" id="userMenuContainer">
        <button class="button header-icon-button" id="userMenuButton">
          <i data-lucide="<%= emojiToLucide('👤') %>"></i>
          <span>ユーザー</span>
          <i data-lucide="<%= emojiToLucide('▼') %>" class="dropdown-arrow"></i>
        </button>
        <div class="dropdown-content">
          <ul>
            <% if (typeof user !== 'undefined' && user && user.role === 'system_admin' && !user.isImpersonating) { %>
            <li><button id="adminDashboardButton">システム管理</button></li>
            <% } %>
            <li><button id="logoutButton">ログアウト</button></li>
            <li><button id="deleteAccountButton" class="delete-btn">アカウント削除</button></li>
          </ul>
        </div>
      </div>
      <div class="auth-controls">
        <button id="loginButton">Googleでログイン</button>
      </div>
    </div>
  </header>
  <div id="landingView" class="view-container" style="display: none;">
    <%- include('partials/_landingView.ejs') %>
  </div>
  <div id="groupDashboard" class="view-container" style="display: none">
    <%- include('partials/_groupDashboard.ejs') %>
  </div>
  <div id="adminDashboard" class="view-container" style="display: none">
    <%- include('partials/_adminDashboard.ejs') %>
  </div>
  <div id="groupEventListView" class="view-container" style="display: none">
    <%- include('partials/_groupEventListView.ejs') %>
  </div>
  <div id="dashboardView" class="view-container" style="display: none">
    <%- include('partials/_dashboardView.ejs') %>
  </div>
  <div id="memberManagementView" class="view-container" style="display: none">
    <%- include('partials/_memberManagementView.ejs') %>
  </div>
  <div id="eventEditView" class="view-container" style="display: none">
    <%- include('partials/_eventEditView.ejs') %>
  </div>
  <div id="broadcastView" class="view-container" style="display: none">
    <%- include('partials/_broadcastView.ejs') %>
  </div>
  <div id="participantView" class="view-container" style="display: none">
    <%- include('partials/_participantView.ejs') %>
  </div>
  <div id="tutorialListView" class="view-container" style="display: none">
    <%- include('partials/_tutorialListView.ejs') %>
  </div>

  <%- include('partials/modals/_groupSettingsModal.ejs') %>
  <%- include('partials/modals/_prizeMasterModal.ejs') %>
  <%- include('partials/modals/_passwordResetRequestModal.ejs') %>
  <%- include('partials/modals/_memberEditModal.ejs') %>
  <%- include('partials/modals/_passwordSetModal.ejs') %>
  <%- include('partials/modals/_profileEditModal.ejs') %>
  <%- include('partials/modals/_prizeMasterSelectModal.ejs') %>
  <%- include('partials/modals/_groupPasswordModal.ejs') %>
  <%- include('partials/modals/_bulkRegisterModal.ejs') %>
  <%- include('partials/modals/_prizeBulkAddModal.ejs') %>
  <%- include('partials/modals/_addPrizeModal.ejs') %>
  <%- include('partials/modals/_summaryModal.ejs') %>
  <%- include('partials/modals/_fillSlotsModal.ejs') %>
  <%- include('partials/modals/_imageCropperModal.ejs') %>
  <%- include('partials/modals/_customConfirmModal.ejs') %>
  <div class="settings-fab" id="settingsFab" title="設定">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.82l-.15-.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1 0-2.82l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
      <circle cx="12" cy="12" r="3"></circle>
    </svg>
  </div>
  <div class="settings-panel" id="settingsPanel">
    <h4>表示設定</h4>
    <div class="setting-item">
      <label for="animationToggle">背景アニメーション</label>
      <label class="switch">
        <input type="checkbox" id="animationToggle">
        <span class="slider round"></span>
      </label>
    </div>
    <div class="setting-item theme-switcher">
      <label>テーマ</label>
      <div class="radio-group">
        <input type="radio" id="theme-auto" name="theme" value="auto">
        <label for="theme-auto">自動</label>
        <input type="radio" id="theme-light" name="theme" value="light">
        <label for="theme-light">ライト</label>
        <input type="radio" id="theme-dark" name="theme" value="dark">
        <label for="theme-dark">ダーク</label>
      </div>
    </div>
  </div>
  <% if (typeof error === 'undefined' || !error) { %>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="/js/tutorial/tutorialData.js"></script>
  <script src="/js/tutorial/tutorialUtils.js"></script>
  <script src="/js/tutorial/tutorialManager.js"></script>
  <script src="/js/tutorial/tutorialList.js"></script>
  <script type="module" src="/js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script src="https://unpkg.com/@panzoom/panzoom@4.6.0/dist/panzoom.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC6gjEuKa8S-ZFbhzPi-GS8zX4L9KdiUPQ",
      authDomain: "amidakuji-app-native.firebaseapp.com",
      projectId: "amidakuji-app-native",
      storageBucket: "amidakuji-app-native.appspot.com",
      messagingSenderId: "482453338621",
      appId: "1:482453338621:web:5e268f146a8d778f4e0194",
      measurementId: "G-K205CFXBDE"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
  </script>
  <script>
    <% if (typeof emojiMapJSON !== 'undefined' && emojiMapJSON) { %>
    window.emojiMapData = <%- emojiMapJSON %>;
    <% } else { %>
    window.emojiMapData = [];
    <% } %>
    <% if (typeof groupData !== 'undefined' && groupData) { %>
    const initialGroupData = <%- groupData %>;
    <% } else { %>
    const initialGroupData = null;
    <% } %>
    <% if (typeof eventData !== 'undefined' && eventData) { %>
    const initialEventData = <%- eventData %>;
    <% } else { %>
    const initialEventData = null;
    <% } %>
  </script>
  <% } %>
</body>

</html>