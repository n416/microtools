<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‚¹æ»´äºˆæ¸¬ãƒ„ãƒ¼ãƒ«ï¼ˆè‡ªå‹•å…¥åŠ›å¯¾å¿œç‰ˆï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        /* --- è‰²å®šç¾© (CSSå¤‰æ•°) --- */
        :root {
            /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ */
            --bg-body: #ecf0f1;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --card-bg: #ffffff;
            --card-shadow: rgba(0,0,0,0.05);
            
            --speed-box-bg: #f8f9fa;
            
            --rt-card-bg: #e8f6f3;
            --rt-border: #1abc9c;
            --rt-title: #16a085;
            --rt-val: #0e6655;
            
            --input-area-bg: #ecf0f1;
            --key-bg: #fdfdfd;
            --key-text: #333;
            --key-shadow: rgba(0,0,0,0.1);
            --key-active: #ecf0f1;
            
            --chart-grid: #ddd;
            --chart-text: #666;

            --btn-suspend-bg: #95a5a6;
            --btn-resume-bg: #2ecc71;
            --btn-text: #fff;
        }

        body.dark-mode {
            /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
            --bg-body: #121212;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --card-bg: #1e1e1e;
            --card-shadow: rgba(0,0,0,0.5);
            
            --speed-box-bg: #2c2c2c;
            
            --rt-card-bg: #0b2b24; 
            --rt-border: #16a085;
            --rt-title: #1abc9c;
            --rt-val: #a3e4d7;
            
            --input-area-bg: #2c2c2c;
            --key-bg: #333;
            --key-text: #eee;
            --key-shadow: rgba(0,0,0,0.3);
            --key-active: #444;
            
            --chart-grid: #444;
            --chart-text: #aaa;

            --btn-suspend-bg: #7f8c8d;
            --btn-resume-bg: #27ae60;
        }

        /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; padding: 0; 
            background: var(--bg-body); 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            display: flex;
            color: var(--text-main);
        }

        /* å·¦å´ãƒ‘ãƒãƒ« */
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 15px;
            height: 100%;
        }

        /* å³å´ãƒ‘ãƒãƒ« */
        .right-panel {
            width: 320px;
            background: var(--card-bg);
            padding: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 10px var(--card-shadow);
            z-index: 10;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 5px var(--card-shadow);
            padding: 12px 15px;
        }

        /* 1. çµ‚äº†äºˆå®šã‚«ãƒ¼ãƒ‰ */
        .status-card {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 10px;
            align-items: center;
        }
        .finish-label { font-size: 0.8rem; color: var(--text-sub); }
        .finish-time { font-size: 3rem; font-weight: 800; line-height: 1; color: var(--text-main); letter-spacing: -2px; }
        .finish-sub { font-size: 0.8rem; color: var(--text-sub); margin-top: 5px;}
        
        .speed-box {
            background: var(--speed-box-bg); border-radius: 8px; padding: 8px;
            display: flex; flex-direction: column; justify-content: center; height: 100%;
        }
        .speed-row { display: flex; justify-content: space-between; align-items: baseline; font-size: 0.9rem;}
        .speed-val { font-weight: bold; font-size: 1.2rem; }

        /* 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¨å®šã‚«ãƒ¼ãƒ‰ */
        .realtime-card {
            background: var(--rt-card-bg);
            border-left: 5px solid var(--rt-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .rt-title { font-size: 0.9rem; color: var(--rt-title); font-weight: bold; }
        .rt-value { font-size: 2.2rem; font-weight: bold; color: var(--rt-val); }
        .rt-range { font-size: 0.9rem; color: var(--rt-title); text-align: right; }
        .rt-blink { animation: blink 2s infinite; color: var(--rt-title); font-size: 0.8em;}
        
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* 3. ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ */
        .chart-card {
            flex: 1; 
            position: relative;
            min-height: 0; 
        }
        #chart-container {
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
        }

        /* å³å´UIãƒ‘ãƒ¼ãƒ„ */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .app-title { font-weight: bold; font-size: 1.1rem; }
        
        .header-buttons { display: flex; gap: 8px; }
        .btn-common { border: none; padding: 6px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
        .btn-reset { background: #e74c3c; color: white; }
        .btn-theme { background: var(--speed-box-bg); color: var(--text-main); border: 1px solid var(--text-sub); }
        
        .input-display-area {
            background: var(--input-area-bg); border-radius: 8px; padding: 15px;
            text-align: right; margin-bottom: 10px; height: 70px;
            display: flex; flex-direction: column; justify-content: center;
        }
        .input-val { font-size: 2.2rem; font-weight: bold; color: var(--text-main); line-height: 1; }
        
        /* çŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
        .state-buttons {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;
        }
        .btn-state {
            border: none; padding: 12px; border-radius: 6px;
            font-weight: bold; color: var(--btn-text); cursor: pointer;
            font-size: 0.9rem;
        }
        .btn-suspend { background: var(--btn-suspend-bg); }
        .btn-resume { background: var(--btn-resume-bg); }
        .btn-state:active { opacity: 0.8; transform: scale(0.98); }
        
        .numpad { flex: 1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .key {
            border: none; background: var(--key-bg); border-radius: 6px;
            font-size: 1.4rem; font-weight: 600; color: var(--key-text);
            box-shadow: 0 2px 3px var(--key-shadow);
            cursor: pointer; touch-action: manipulation;
        }
        .key:active { background: var(--key-active); transform: scale(0.98); }
        .key-enter { grid-column: span 2; background: #3498db; color: white; font-size: 1.1rem; }
        .key-enter:active { background: #2980b9; }
        .key-undo { background: #f39c12; color: white; font-size: 0.9rem; }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; height: auto; }
            .left-panel { height: auto; flex: none; }
            .chart-card { height: 300px; }
            .right-panel { width: 100%; flex: none; position: sticky; bottom: 0; border-top: 1px solid #444; padding-bottom: 30px;} 
            .numpad { height: 220px; }
        }
    </style>
</head>
<body>

    <div class="left-panel">
        <div class="card status-card">
            <div>
                <div class="finish-label">çµ‚äº†äºˆå®šæ™‚åˆ» (äºˆæ¸¬)</div>
                <div class="finish-time" id="finishTime">--:--</div>
                <div class="finish-sub" id="finishSub">ãƒ‡ãƒ¼ã‚¿å¾…æ©Ÿä¸­</div>
            </div>
            <div class="speed-box">
                <div class="speed-row"><span>åˆ†é€Ÿ</span> <span><span class="speed-val" id="speedMin">0.0</span> ml</span></div>
                <div style="height:1px; background:var(--text-sub); opacity:0.3; margin:4px 0;"></div>
                <div class="speed-row"><span>æ™‚é€Ÿ</span> <span><span class="speed-val" id="speedHour">0</span> ml</span></div>
            </div>
        </div>

        <div class="card realtime-card">
            <div>
                <div class="rt-title">ç¾åœ¨æ®‹é‡ï¼ˆæ¨å®šï¼‰<span class="rt-blink" id="rtIndicator">â—</span></div>
                <div class="rt-value" id="rtCurrent">-- ml</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size:0.7rem; color:var(--rt-title);">äºˆæ¸¬ç¯„å›²</div>
                <div class="rt-range" id="rtRange">-- ã€œ -- ml</div>
            </div>
        </div>

        <div class="card chart-card">
            <div id="chart-container">
                <canvas id="ivChart"></canvas>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div class="header-row">
            <div class="app-title">ğŸ’§ ç‚¹æ»´ç®¡ç†</div>
            <div class="header-buttons">
                <button class="btn-common btn-theme" onclick="toggleTheme()" id="themeBtn">â˜€ï¸</button>
                <button class="btn-common btn-reset" onclick="resetData()">å…¨æ¶ˆå»</button>
            </div>
        </div>

        <div class="input-display-area">
            <div style="font-size:0.7rem; color:var(--text-sub);">è¨˜éŒ²ã™ã‚‹æ®‹é‡ (ml)</div>
            <div class="input-val"><span id="inputDisplay"></span><span style="border-right:2px solid #3498db; margin-left:2px; animation:blink 1s infinite;"></span></div>
        </div>
        
        <div class="state-buttons">
            <button class="btn-state btn-suspend" onclick="submitLog('suspend')">â¸ å–å¤–ã— (ä¸­æ–­)</button>
            <button class="btn-state btn-resume" onclick="submitLog('resume')">â–¶ å–ä»˜ã‘ (å†é–‹)</button>
        </div>

        <div class="numpad">
            <button class="key" onclick="press(7)">7</button>
            <button class="key" onclick="press(8)">8</button>
            <button class="key" onclick="press(9)">9</button>
            <button class="key" onclick="press(4)">4</button>
            <button class="key" onclick="press(5)">5</button>
            <button class="key" onclick="press(6)">6</button>
            <button class="key" onclick="press(1)">1</button>
            <button class="key" onclick="press(2)">2</button>
            <button class="key" onclick="press(3)">3</button>
            <button class="key key-undo" onclick="undo()">è¨‚æ­£</button>
            <button class="key" onclick="press(0)">0</button>
            <button class="key key-enter" onclick="submitLog('normal')">è¨˜éŒ²ã™ã‚‹</button>
        </div>
    </div>

<script>
    let logs = []; 
    let currentInput = "";
    const STORAGE_KEY = 'iv_tool_tablet_v3';
    const THEME_KEY = 'iv_tool_theme_mode';
    
    // ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–
    const ctx = document.getElementById('ivChart').getContext('2d');
    let chart;

    function initChart() {
        chart = new Chart(ctx, {
            type: 'line',
            data: { datasets: [{
                label: 'å®Ÿæ¸¬å€¤',
                data: [],
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                fill: true,
                tension: 0,
                pointRadius: 5
            }, {
                label: 'äºˆæ¸¬ç·š',
                data: [],
                borderColor: '#e74c3c',
                borderDash: [5, 5],
                pointRadius: 0,
                borderWidth: 2
            }]},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: 5 },
                scales: {
                    x: { 
                        type: 'time', 
                        time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } },
                        grid: { color: getComputedStyle(document.body).getPropertyValue('--chart-grid') },
                        ticks: { color: getComputedStyle(document.body).getPropertyValue('--chart-text') }
                    },
                    y: { 
                        min: 0, 
                        title: { display: true, text: 'æ®‹é‡ (ml)', color: getComputedStyle(document.body).getPropertyValue('--chart-text') },
                        grid: { color: getComputedStyle(document.body).getPropertyValue('--chart-grid') },
                        ticks: { color: getComputedStyle(document.body).getPropertyValue('--chart-text') }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- ãƒ†ãƒ¼ãƒç®¡ç† ---
    function initTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        const hour = new Date().getHours();
        let isDark = saved === 'dark' || (!saved && (hour >= 18 || hour < 6));
        applyTheme(isDark);
        initChart();
        loadData();
    }

    function toggleTheme() {
        const isDark = document.body.classList.contains('dark-mode');
        applyTheme(!isDark);
        localStorage.setItem(THEME_KEY, !isDark ? 'dark' : 'light');
    }

    function applyTheme(isDark) {
        const btn = document.getElementById('themeBtn');
        if (isDark) {
            document.body.classList.add('dark-mode');
            btn.innerText = 'ğŸŒ™';
        } else {
            document.body.classList.remove('dark-mode');
            btn.innerText = 'â˜€ï¸';
        }
        if (chart) {
            const styles = getComputedStyle(document.body);
            const gridColor = styles.getPropertyValue('--chart-grid');
            const textColor = styles.getPropertyValue('--chart-text');
            chart.options.scales.x.grid.color = gridColor;
            chart.options.scales.x.ticks.color = textColor;
            chart.options.scales.y.grid.color = gridColor;
            chart.options.scales.y.ticks.color = textColor;
            chart.options.scales.y.title.color = textColor;
            chart.update();
        }
    }

    // --- ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---

    setInterval(updateRealTimeStatus, 1000);

    function press(num) {
        if (currentInput.length > 3) return;
        currentInput += num;
        document.getElementById('inputDisplay').innerText = currentInput;
    }

    function submitLog(type = 'normal') {
        let val;
        
        // å…¥åŠ›ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’å„ªå…ˆ
        if (currentInput !== "") {
            val = parseFloat(currentInput);
        } else {
            // --- è‡ªå‹•è£œå®Œãƒ­ã‚¸ãƒƒã‚¯ ---
            if (logs.length === 0) {
                alert("æœ€åˆã®æ®‹é‡ã¯å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
            const lastLog = logs[logs.length - 1];

            if (type === 'suspend') {
                // ä¸­æ–­æ™‚ã¯ã€Œç¾åœ¨ã®æ¨å®šå€¤ã€ã‚’è‡ªå‹•æ¡ç”¨
                const rate = getLastValidRate();
                const elapsed = (new Date() - lastLog.time) / 60000;
                
                if (lastLog.type === 'suspend') {
                    // æ—¢ã«ä¸­æ–­ä¸­ãªã‚‰å€¤ã‚’å¤‰ãˆãªã„
                    val = lastLog.volume; 
                } else {
                    // æ¨å®šå€¤ã‚’è¨ˆç®—ã—ã¦æ¡ç”¨
                    let est = lastLog.volume - (rate * elapsed);
                    if (est < 0) est = 0;
                    val = parseFloat(est.toFixed(0)); // æ•´æ•°ä¸¸ã‚
                }
            } else if (type === 'resume') {
                // å†é–‹æ™‚ã¯ã€Œç›´å‰ã®å€¤ï¼ˆä¸­æ–­æ™‚ã®å€¤ï¼‰ã€ã‚’è‡ªå‹•æ¡ç”¨
                // ä¸­æ–­ä¸­ã¯æ¸›ã‚‰ãªã„å‰æ
                val = lastLog.volume;
            } else {
                // é€šå¸¸è¨˜éŒ²ãƒœã‚¿ãƒ³ã§ç©ºæ¬„ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
                alert("æ®‹é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
        }

        // è¨˜éŒ²
        logs.push({ 
            time: new Date(), 
            volume: val,
            type: type
        });

        saveData();
        currentInput = "";
        document.getElementById('inputDisplay').innerText = "";
        recalculate();
    }

    function undo() {
        if (currentInput.length > 0) {
            currentInput = currentInput.slice(0, -1);
            document.getElementById('inputDisplay').innerText = currentInput;
        } else if (logs.length > 0 && confirm('ç›´è¿‘ã®è¨˜éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) {
            logs.pop();
            saveData();
            recalculate();
        }
    }

    function resetData() {
        if (confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) {
            logs = [];
            localStorage.removeItem(STORAGE_KEY);
            currentInput = "";
            document.getElementById('inputDisplay').innerText = "";
            recalculate();
        }
    }

    // éå»ã®ãƒ­ã‚°ã‹ã‚‰ã€æœ€æ–°ã®æœ‰åŠ¹ãªæ»´ä¸‹é€Ÿåº¦(ml/min)ã‚’å–å¾—ã™ã‚‹
    function getLastValidRate() {
        if (logs.length < 2) return 0;
        
        for (let i = logs.length - 1; i > 0; i--) {
            const cur = logs[i];
            const prev = logs[i-1];
            
            if (cur.type === 'resume' && prev.type === 'suspend') continue;
            if (prev.type === 'suspend') continue;

            const diffMin = (cur.time - prev.time) / 60000;
            const diffVol = prev.volume - cur.volume;
            
            if (diffMin > 0 && diffVol > 0) {
                return diffVol / diffMin;
            }
        }
        return 0;
    }

    function recalculate() {
        // ã‚°ãƒ©ãƒ•æ›´æ–°
        chart.data.datasets[0].data = logs.map(l => ({ x: l.time, y: l.volume }));
        
        if (logs.length < 1) {
            resetDisplay("ãƒ‡ãƒ¼ã‚¿ä¸è¶³");
            chart.data.datasets[1].data = [];
            chart.update();
            updateRealTimeStatus();
            return;
        }

        const last = logs[logs.length - 1];

        // --- ä¸­æ–­ä¸­ã®å ´åˆ ---
        if (last.type === 'suspend') {
            document.getElementById('finishTime').innerText = "ä¸­æ–­ä¸­";
            document.getElementById('finishSub').innerText = "å†é–‹æ™‚ã«å†è¨ˆç®—ã—ã¾ã™";
            document.getElementById('speedMin').innerText = "0.0";
            document.getElementById('speedHour').innerText = "0";
            document.getElementById('rtIndicator').style.color = "#bdc3c7"; 
            document.getElementById('rtIndicator').style.animation = "none";
            
            chart.data.datasets[1].data = [];
            chart.update();
            updateRealTimeStatus();
            return;
        }

        // --- é€šå¸¸ or å†é–‹æ™‚ ---
        document.getElementById('rtIndicator').style.color = ""; 
        document.getElementById('rtIndicator').style.animation = "blink 2s infinite";

        const ratePerMin = getLastValidRate();

        if (ratePerMin <= 0) {
            resetDisplay("ãƒ‡ãƒ¼ã‚¿åé›†å¾…ã¡");
            chart.update();
            return;
        }

        const remainingMin = last.volume / ratePerMin;
        const finishDate = new Date(last.time.getTime() + remainingMin * 60000);
        
        document.getElementById('speedMin').innerText = ratePerMin.toFixed(1);
        document.getElementById('speedHour').innerText = (ratePerMin * 60).toFixed(0);
        document.getElementById('finishTime').innerText = finishDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
        if (last.type === 'resume') {
            document.getElementById('finishSub').innerText = "å‰å›é€Ÿåº¦ã§äºˆæ¸¬ä¸­";
        } else {
            document.getElementById('finishSub').innerText = "äºˆæ¸¬ä¸­";
        }

        chart.data.datasets[1].data = [{ x: last.time, y: last.volume }, { x: finishDate, y: 0 }];
        chart.update();

        updateRealTimeStatus();
    }

    function updateRealTimeStatus() {
        if (logs.length === 0) {
            document.getElementById('rtCurrent').innerText = "-- ml";
            document.getElementById('rtRange').innerText = "--";
            return;
        }

        const last = logs[logs.length - 1];
        
        if (last.type === 'suspend') {
            document.getElementById('rtCurrent').innerText = `${last.volume} ml`;
            document.getElementById('rtRange').innerText = "ä¸­æ–­ä¸­";
            return;
        }

        const ratePerMin = getLastValidRate();
        if (ratePerMin <= 0) {
            document.getElementById('rtCurrent').innerText = `${last.volume} ml`;
            return;
        }

        const now = new Date();
        const elapsedMin = (now - last.time) / 60000;
        let est = last.volume - (ratePerMin * elapsedMin);
        if (est < 0) est = 0;

        document.getElementById('rtCurrent').innerText = `${est.toFixed(0)} ml`;
        
        if (last.type === 'resume') {
            document.getElementById('rtRange').innerText = `(å‰å›é€Ÿåº¦ã§æ¨å®š)`;
        } else {
            document.getElementById('rtRange').innerText = `æ¨å®šä¸­`;
        }
    }

    function resetDisplay(msg) {
        document.getElementById('finishTime').innerText = "--:--";
        document.getElementById('finishSub').innerText = msg;
        document.getElementById('speedMin').innerText = "0.0";
        document.getElementById('speedHour').innerText = "0";
    }

    function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(logs)); }
    function loadData() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            try {
                logs = JSON.parse(stored).map(l => ({ 
                    time: new Date(l.time), 
                    volume: l.volume,
                    type: l.type || 'normal'
                }));
                recalculate();
            } catch (e) { logs = []; }
        }
    }

    initTheme();
</script>
</body>
</html>