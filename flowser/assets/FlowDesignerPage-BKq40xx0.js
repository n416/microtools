import{n as e,t}from"./useThemeProps-CfGR5xfj.js";import{R as n,b as r,c as i,m as a,t as o}from"./Header-D7rWC5z9.js";import{t as s}from"./TextField-Dil_rayB.js";import{B as c,C as l,E as u,N as d,S as f,T as p,V as m,f as h,i as g,l as _,m as v,t as y,w as b}from"./index-CiSiJNZM.js";const x=(e,t)=>e.filter(e=>t.includes(e)),S=(e,t,n)=>{let r=e.keys[0];Array.isArray(t)?t.forEach((t,r)=>{n((t,n)=>{r<=e.keys.length-1&&(r===0?Object.assign(t,n):t[e.up(e.keys[r])]=n)},t)}):t&&typeof t==`object`?(Object.keys(t).length>e.keys.length?e.keys:x(e.keys,Object.keys(t))).forEach(i=>{if(e.keys.includes(i)){let a=t[i];a!==void 0&&n((t,n)=>{r===i?Object.assign(t,n):t[e.up(i)]=n},a)}}):(typeof t==`number`||typeof t==`string`)&&n((e,t)=>{Object.assign(e,t)},t)};function C(e){return`--Grid-${e}Spacing`}function w(e){return`--Grid-parent-${e}Spacing`}var T=`--Grid-columns`,E=`--Grid-parent-columns`;const D=({theme:e,ownerState:t})=>{let n={};return S(e.breakpoints,t.size,(e,t)=>{let r={};t===`grow`&&(r={flexBasis:0,flexGrow:1,maxWidth:`100%`}),t===`auto`&&(r={flexBasis:`auto`,flexGrow:0,flexShrink:0,maxWidth:`none`,width:`auto`}),typeof t==`number`&&(r={flexGrow:0,flexBasis:`auto`,width:`calc(100% * ${t} / var(${E}) - (var(${E}) - ${t}) * (var(${w(`column`)}) / var(${E})))`}),e(n,r)}),n},O=({theme:e,ownerState:t})=>{let n={};return S(e.breakpoints,t.offset,(e,t)=>{let r={};t===`auto`&&(r={marginLeft:`auto`}),typeof t==`number`&&(r={marginLeft:t===0?`0px`:`calc(100% * ${t} / var(${E}) + var(${w(`column`)}) * ${t} / var(${E}))`}),e(n,r)}),n},k=({theme:e,ownerState:t})=>{if(!t.container)return{};let n={[T]:12};return S(e.breakpoints,t.columns,(e,t)=>{let r=t??12;e(n,{[T]:r,"> *":{[E]:r}})}),n},A=({theme:e,ownerState:t})=>{if(!t.container)return{};let n={};return S(e.breakpoints,t.rowSpacing,(t,r)=>{let i=typeof r==`string`?r:e.spacing?.(r);t(n,{[C(`row`)]:i,"> *":{[w(`row`)]:i}})}),n},j=({theme:e,ownerState:t})=>{if(!t.container)return{};let n={};return S(e.breakpoints,t.columnSpacing,(t,r)=>{let i=typeof r==`string`?r:e.spacing?.(r);t(n,{[C(`column`)]:i,"> *":{[w(`column`)]:i}})}),n},M=({theme:e,ownerState:t})=>{if(!t.container)return{};let n={};return S(e.breakpoints,t.direction,(e,t)=>{e(n,{flexDirection:t})}),n},N=({ownerState:e})=>({minWidth:0,boxSizing:`border-box`,...e.container&&{display:`flex`,flexWrap:`wrap`,...e.wrap&&e.wrap!==`wrap`&&{flexWrap:e.wrap},gap:`var(${C(`row`)}) var(${C(`column`)})`}}),P=e=>{let t=[];return Object.entries(e).forEach(([e,n])=>{n!==!1&&n!==void 0&&t.push(`grid-${e}-${String(n)}`)}),t},F=(e,t=`xs`)=>{function n(e){return e===void 0?!1:typeof e==`string`&&!Number.isNaN(Number(e))||typeof e==`number`&&e>0}if(n(e))return[`spacing-${t}-${String(e)}`];if(typeof e==`object`&&!Array.isArray(e)){let t=[];return Object.entries(e).forEach(([e,r])=>{n(r)&&t.push(`spacing-${e}-${String(r)}`)}),t}return[]},I=e=>e===void 0?[]:typeof e==`object`?Object.entries(e).map(([e,t])=>`direction-${e}-${t}`):[`direction-xs-${String(e)}`];function L(e,t){let n=[];e.item!==void 0&&(delete e.item,n.push(`item`)),e.zeroMinWidth!==void 0&&(delete e.zeroMinWidth,n.push(`zeroMinWidth`)),t.keys.forEach(t=>{e[t]!==void 0&&(n.push(t),delete e[t])})}var R=m(c()),z=m(d()),B=u(),V=e(`div`,{name:`MuiGrid`,slot:`Root`});function H(e){return t({props:e,name:`MuiGrid`,defaultTheme:B})}function U(e={}){let{createStyledComponent:t=V,useThemeProps:r=H,useTheme:i=p,componentName:a=`MuiGrid`}=e,o=(e,t)=>{let{container:n,direction:r,spacing:i,wrap:o,size:s}=e,c={root:[`root`,n&&`container`,o!==`wrap`&&`wrap-xs-${String(o)}`,...I(r),...P(s),...n?F(i,t.breakpoints.keys[0]):[]]};return v(c,e=>f(a,e),{})};function s(e,t,n=()=>!0){let r={};return e===null||(Array.isArray(e)?e.forEach((e,i)=>{e!==null&&n(e)&&t.keys[i]&&(r[t.keys[i]]=e)}):typeof e==`object`?Object.keys(e).forEach(t=>{let i=e[t];i!=null&&n(i)&&(r[t]=i)}):r[t.keys[0]]=e),r}let c=t(k,j,A,D,M,N,O),u=R.forwardRef(function(e,t){let a=i(),u=r(e),d=b(u);L(d,a.breakpoints);let{className:f,children:p,columns:m=12,container:h=!1,component:g=`div`,direction:_=`row`,wrap:v=`wrap`,size:y={},offset:x={},spacing:S=0,rowSpacing:C=S,columnSpacing:w=S,unstable_level:T=0,...E}=d,D=s(y,a.breakpoints,e=>e!==!1),O=s(x,a.breakpoints),k=e.columns??(T?void 0:m),A=e.spacing??(T?void 0:S),j=e.rowSpacing??e.spacing??(T?void 0:C),M=e.columnSpacing??e.spacing??(T?void 0:w),N={...d,level:T,columns:k,container:h,direction:_,wrap:v,spacing:A,rowSpacing:j,columnSpacing:M,size:D,offset:O},P=o(N,a);return(0,z.jsx)(c,{ref:t,as:g,ownerState:N,className:l(P.root,f),...E,children:R.Children.map(p,e=>R.isValidElement(e)&&n(e,[`Grid`])&&h&&e.props.container?R.cloneElement(e,{unstable_level:e.props?.unstable_level??T+1}):e)})});return u.muiName=`Grid`,u}var W=U({createStyledComponent:_(`div`,{name:`MuiGrid`,slot:`Root`,overridesResolver:(e,t)=>{let{ownerState:n}=e;return[t.root,n.container&&t.container]}}),componentName:`MuiGrid`,useThemeProps:e=>g({props:e,name:`MuiGrid`}),useTheme:h}),G=class{#geminiApiKey=null;#isKeyValid=!1;#baseUrl=`https://generativelanguage.googleapis.com/v1beta/models`;constructor(){try{let e=localStorage.getItem(`geminiApiKey`);e?(this.#geminiApiKey=e,this.#isKeyValid=!0):this.#isKeyValid=!1}catch(e){console.error(`Failed to access localStorage for API Key:`,e),this.#isKeyValid=!1}}get isAvailable(){return this.#isKeyValid}static async listAvailableModels(e){if(!e)throw Error(`APIキーがありません。`);let t=`https://generativelanguage.googleapis.com/v1beta/models?key=${e}`,n=await fetch(t),r=await n.json();if(!n.ok){let e=r?.error?.message||`不明なエラー`;throw Error(`モデルリストの取得に失敗しました (${n.status}): ${e}`)}return r.models}async generateContent(e,t){if(!this.isAvailable)throw Error(`Gemini APIキーが設定されていません。`);let n=t.startsWith(`models/`)?t.split(`/`)[1]:t,r=`${this.#baseUrl}/${n}:generateContent?key=${this.#geminiApiKey}`,i={contents:[{parts:[{text:e}]}],safetySettings:[{category:`HARM_CATEGORY_HARASSMENT`,threshold:`BLOCK_NONE`},{category:`HARM_CATEGORY_HATE_SPEECH`,threshold:`BLOCK_NONE`},{category:`HARM_CATEGORY_SEXUALLY_EXPLICIT`,threshold:`BLOCK_NONE`},{category:`HARM_CATEGORY_DANGEROUS_CONTENT`,threshold:`BLOCK_NONE`}]},a=await fetch(r,{method:`POST`,headers:{"Content-Type":`application/json`},body:JSON.stringify(i)}),o=await a.json();if(!a.ok){let e=o?.error?.message||`不明なエラー`;throw Error(`APIリクエストに失敗しました (${a.status}): ${e}`)}if(!o.candidates?.[0]?.content?.parts?.[0]?.text){if(o.candidates?.[0]?.finishReason===`SAFETY`)throw Error(`AIから有効な応答が得られませんでした。理由: 安全性設定によりブロックされました。`);let e=o.promptFeedback?.blockReason||o.candidates?.[0]?.finishReason||`不明`;throw Error(`AIから有効な応答が得られませんでした。理由: ${e}`)}return o.candidates[0].content.parts[0].text}};function K(){let[e,t]=(0,R.useState)([]),[n,c]=(0,R.useState)(``),[l,u]=(0,R.useState)(``),[d,f]=(0,R.useState)([]),[p,m]=(0,R.useState)(!1),[h,g]=(0,R.useState)(``);return(0,R.useEffect)(()=>{let e=JSON.parse(localStorage.getItem(`knowledgeBase`))||[];t(e)},[]),(0,z.jsxs)(y,{sx:{display:`flex`,flexDirection:`column`,height:`100vh`,bgcolor:`background.default`},children:[(0,z.jsx)(y,{sx:{p:`0 24px`},children:(0,z.jsx)(o,{onResetData:()=>{window.confirm(`保存されている全てのデータをリセットします。よろしいですか？`)&&(localStorage.clear(),window.location.reload())},isLocked:!1})}),(0,z.jsx)(y,{sx:{flexGrow:1,p:`0 24px 24px 24px`,display:`flex`,gap:2,minHeight:0},children:(0,z.jsxs)(W,{container:!0,spacing:2,children:[(0,z.jsx)(W,{item:!0,xs:12,md:5,children:(0,z.jsxs)(r,{sx:{p:2,height:`100%`,display:`flex`,flexDirection:`column`},children:[(0,z.jsx)(a,{variant:`h6`,gutterBottom:!0,children:`① 知識ベース`}),(0,z.jsx)(s,{label:`新しい知識`,multiline:!0,rows:4,variant:`outlined`,fullWidth:!0,value:n,onChange:e=>c(e.target.value),placeholder:`例: 普通自動車の契約には印鑑証明書が必要`,sx:{mb:1}}),(0,z.jsx)(i,{variant:`contained`,onClick:()=>{if(n.trim()){let r=e.length>0?Math.max(...e.map(e=>parseInt(e.id.substring(1))))+1:1,i={id:`K${String(r).padStart(3,`0`)}`,text:n.trim()},a=[...e,i];t(a),localStorage.setItem(`knowledgeBase`,JSON.stringify(a)),c(``)}},sx:{mb:2},children:`知識を登録`}),(0,z.jsx)(y,{sx:{overflow:`auto`,flexGrow:1},children:e.map(e=>(0,z.jsxs)(r,{variant:`outlined`,sx:{p:1,mb:1},children:[(0,z.jsx)(a,{variant:`caption`,children:e.id}),(0,z.jsx)(a,{variant:`body2`,children:e.text})]},e.id))})]})}),(0,z.jsx)(W,{item:!0,xs:12,md:7,children:(0,z.jsxs)(r,{sx:{p:2,height:`100%`,display:`flex`,flexDirection:`column`},children:[(0,z.jsx)(a,{variant:`h6`,gutterBottom:!0,children:`② フロー生成`}),(0,z.jsx)(s,{label:`AIへの指示`,multiline:!0,rows:4,variant:`outlined`,fullWidth:!0,value:l,onChange:e=>u(e.target.value),placeholder:`例: 軽自動車の新規契約で、値引き交渉があった場合のフロー`,sx:{mb:1}}),(0,z.jsx)(i,{variant:`contained`,color:`primary`,onClick:async()=>{if(!l.trim()||e.length===0){alert(`「知識ベース」と「AIへの指示」の両方を入力してください。`);return}m(!0),f([]);try{let t=new G;if(!t.isAvailable)throw Error(`APIキーが未設定です。右上の設定アイコンからAPIキーを登録してください。`);let n=`あなたは優秀な業務コンサルタントです。以下の【知識リスト】を制約条件として厳守し、ユーザーからの【指示】に合致する業務フローを、論理的に矛盾のないステップ・バイ・ステップのリスト形式で提案してください。各ステップがどの知識に基づいているか、IDを明記してください。\n\n【知識リスト】\n${e.map(e=>`${e.id}: ${e.text}`).join(`
`)}\n\n【指示】\n${l}\n\n【出力形式】\n- (タスク内容1) (根拠: KXXX)\n- (タスク内容2) (根拠: KXXX)\n- (AIが補完したタスク内容)`,r=(await t.generateContent(n,`gemini-pro`)).split(`
`).filter(e=>e.trim().startsWith(`-`)).map((e,t)=>{let n=e.match(/- (.+?) \(根拠: (K\d+)\)/);return{id:t+1,text:n?n[1].trim():e.replace(`-`,``).trim(),refId:n?n[2].trim():`AI`,completed:!1,details:``}});f(r)}catch(e){console.error(`API呼び出し中にエラーが発生しました:`,e),alert(`エラー: ${e.message}`)}finally{m(!1)}},disabled:p,children:p?`生成中...`:`フローを生成`}),(0,z.jsx)(y,{sx:{overflow:`auto`,flexGrow:1,my:2,p:1,border:`1px solid #eee`,borderRadius:1},children:d.map(e=>(0,z.jsxs)(r,{variant:`outlined`,sx:{p:1,mb:1,display:`flex`,alignItems:`center`,gap:1},children:[(0,z.jsx)(a,{variant:`caption`,sx:{bgcolor:`grey.200`,p:`2px 8px`,borderRadius:`12px`},children:e.refId}),(0,z.jsx)(a,{variant:`body2`,children:e.text})]},e.id))}),(0,z.jsxs)(y,{sx:{display:`flex`,gap:2},children:[(0,z.jsx)(s,{label:`新しいフロー名`,variant:`outlined`,fullWidth:!0,value:h,onChange:e=>g(e.target.value)}),(0,z.jsx)(i,{variant:`contained`,color:`success`,onClick:()=>{if(!h.trim()){alert(`フロー名を入力してください。`);return}if(d.length===0){alert(`保存するタスクがありません。`);return}let e=JSON.parse(localStorage.getItem(`workflowLibrary`))||[],t={id:`wf${Date.now()}`,name:h.trim(),description:`AIによって「${l.substring(0,20)}...」という指示を元に生成されました。`,tasks:d};e.push(t),localStorage.setItem(`workflowLibrary`,JSON.stringify(e)),alert(`新しいフローが保存されました！顧客管理画面で利用できます。`),g(``),u(``),f([])},children:`このフローを保存`})]})]})})]})})]})}var q=K;export{q as default};